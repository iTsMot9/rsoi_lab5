name: GitHub Classroom Workflow
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  build:
    name: Autograding
    runs-on: ubuntu-latest
    services:
      keycloak:
        image: quay.io/keycloak/keycloak:23.0
        ports:
          - 8080:8080
        env:
          KEYCLOAK_ADMIN: admin
          KEYCLOAK_ADMIN_PASSWORD: admin
          KC_HEALTH_ENABLED: "true"
          KC_METRICS_ENABLED: "true"
          KC_DB: "dev-file"
          KC_FEATURES: "scripts"
        options: >-
          --health-cmd="curl -f http://localhost:8080/health/ready || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python for testing
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Wait for Keycloak startup
        run: |
          sleep 10
          until curl -f http://localhost:8080/health/ready; do
            echo "Waiting for Keycloak to start..."
            sleep 5
          done
          echo "Keycloak is ready!"

      - name: Configure Keycloak realm for tests
        run: |
          sleep 15
          ADMIN_TOKEN=$(curl -X POST http://localhost:8080/realms/master/protocol/openid-connect/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=admin-cli&username=admin&password=admin&grant_type=password" | jq -r '.access_token')
          
          curl -X POST http://localhost:8080/admin/realms \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -d '{
              "realm": "rsoi-realm",
              "enabled": true,
              "clients": [{
                "clientId": "lab5-client",
                "publicClient": true,
                "serviceAccountsEnabled": false,
                "directAccessGrantsEnabled": true,
                "redirectUris": ["*"],
                "webOrigins": ["*"],
                "protocol": "openid-connect",
                "attributes": {
                  "pkce.code.challenge.method": "S256"
                }
              }],
              "users": [{
                "username": "testuser",
                "email": "test@example.com",
                "enabled": true,
                "credentials": [{
                  "type": "password",
                  "value": "testpass",
                  "temporary": false
                }]
              }]
            }'
        continue-on-error: true

      - name: Install dependencies and run unit tests
        env:
          KEYCLOAK_ISSUER: http://localhost:8080/realms/rsoi-realm
          KEYCLOAK_JWKS_URI: http://localhost:8080/realms/rsoi-realm/protocol/openid-connect/certs
          KEYCLOAK_CLIENT_ID: lab5-client
        run: |
          cd src/auth-service
          pip install -r requirements.txt
          
          cd ../car-service
          pip install -r requirements.txt
          python -m pytest test_main.py -v || echo "Unit tests for car-service failed or skipped"
          
          cd ../gateway
          pip install -r requirements.txt
          python -m pytest test_main.py -v || echo "Unit tests for gateway failed or skipped"
          
          cd ../payment-service
          pip install -r requirements.txt
          python -m pytest test_main.py -v || echo "Unit tests for payment-service failed or skipped"
          
          cd ../rental-service
          pip install -r requirements.txt
          python -m pytest test_main.py -v || echo "Unit tests for rental-service failed or skipped"
        continue-on-error: true

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker images
        timeout-minutes: 10
        run: |
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          docker build -t $DOCKER_USERNAME/car-service:${{ github.sha }} ./src/car-service
          docker push $DOCKER_USERNAME/car-service:${{ github.sha }}

          docker build -t $DOCKER_USERNAME/gateway:${{ github.sha }} ./src/gateway
          docker push $DOCKER_USERNAME/gateway:${{ github.sha }}

          docker build -t $DOCKER_USERNAME/payment-service:${{ github.sha }} ./src/payment-service
          docker push $DOCKER_USERNAME/payment-service:${{ github.sha }}

          docker build -t $DOCKER_USERNAME/rental-service:${{ github.sha }} ./src/rental-service
          docker push $DOCKER_USERNAME/rental-service:${{ github.sha }}

      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i /home/runner/yandex-cloud -q
          echo "/home/runner/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure Yandex Cloud CLI
        run: |
          echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY }}' > /tmp/yc-sa-key.json
          if ! jq empty /tmp/yc-sa-key.json 2>/dev/null; then
              echo "Секрет YC_SERVICE_ACCOUNT_KEY содержит невалидный JSON"
              exit 1
          fi
          yc config profile create rsoi-lab5
          yc config profiles activate rsoi-lab5
          yc config set service-account-key /tmp/yc-sa-key.json
          yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}"
          yc config set folder-id "${{ secrets.YC_FOLDER_ID }}"

      - name: Setup KUBECONFIG
        run: |
          mkdir -p $HOME/.kube
          echo '${{ secrets.KUBECONFIG }}' > $HOME/.kube/config
          sed -i "s|/home/[^/]\+/yandex-cloud/bin/yc|/home/runner/yandex-cloud/bin/yc|g" $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify kubectl connection
        run: kubectl cluster-info && kubectl get nodes

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Deploy Keycloak to Kubernetes Cluster
        run: |
          kubectl create namespace rsoi-lab5 --ignore-not-found=true
          helm upgrade --install keycloak oci://registry-1.docker.io/bitnamicharts/keycloak \
            --version 17.3.0 \
            --namespace rsoi-lab5 \
            --set auth.adminUser=admin \
            --set auth.adminPassword=admin \
            --set service.type=ClusterIP \
            --set proxyHeaders=forwarded \
            --set metrics.enabled=false \
            --wait

      - name: Wait for Keycloak Pod in Cluster
        run: kubectl wait -n rsoi-lab5 statefulset.apps/keycloak --for=condition=Ready --timeout=5m

      - name: Configure Keycloak Realm in Cluster
        run: |
          cat <<EOF > /tmp/keycloak-cluster-config.json
          {
            "realm": "rsoi-realm",
            "enabled": true,
            "clients": [{
              "clientId": "lab5-client",
              "publicClient": true,
              "serviceAccountsEnabled": false,
              "directAccessGrantsEnabled": true,
              "redirectUris": ["*"],
              "webOrigins": ["*"],
              "protocol": "openid-connect",
              "attributes": {
                "pkce.code.challenge.method": "S256"
              }
            }],
            "users": [{
              "username": "testuser",
              "email": "test@example.com",
              "enabled": true,
              "credentials": [{
                "type": "password",
                "value": "testpass",
                "temporary": false
              }]
            }]
          }
          EOF
          
          KEYCLOAK_POD_NAME=$(kubectl get pods -n rsoi-lab5 -l app.kubernetes.io/name=keycloak -o jsonpath='{.items[0].metadata.name}')
          echo "Targeting Keycloak pod: $KEYCLOAK_POD_NAME"
          
          kubectl cp /tmp/keycloak-cluster-config.json -n rsoi-lab5 $KEYCLOAK_POD_NAME:/tmp/
          
          sleep 5
          
          kubectl exec -n rsoi-lab5 $KEYCLOAK_POD_NAME -- sh -c '
            ADMIN_TOKEN=$(curl -X POST http://localhost:8080/realms/master/protocol/openid-connect/token \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "client_id=admin-cli&username=admin&password=admin&grant_type=password" | jq -r ".access_token")
            
            curl -X POST http://localhost:8080/admin/realms \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $ADMIN_TOKEN" \
              -d @/tmp/keycloak-cluster-config.json
          '

      - name: Clean up old resources from default namespace
        run: |
          kubectl delete deployment,service,ingress gateway car-service payment-service rental-service -n default --ignore-not-found=true

      - name: Clean up rsoi-lab5 namespace before deploy
        run: |
          kubectl delete deployment,service,ingress gateway car-service payment-service rental-service -n rsoi-lab5 --ignore-not-found=true
          kubectl delete configmap postgres-init-scripts -n rsoi-lab5 --ignore-not-found --timeout=60s
        continue-on-error: true

      - name: Deploy PostgreSQL to Cluster
        run: |
          kubectl apply -f ./postgres/postgres-pvc.yaml -n rsoi-lab5
          kubectl apply -f ./postgres/postgres-configmap.yaml -n rsoi-lab5
          kubectl apply -f ./postgres/postgres-deployment.yaml -n rsoi-lab5
          kubectl apply -f ./postgres/postgres-service.yaml -n rsoi-lab5

      - name: Wait for PostgreSQL in Cluster
        run: kubectl wait -n rsoi-lab5 deployment/postgres --for=condition=Available --timeout=5m

      - name: Update Helm Values for Services (Set Image Tags)
        run: |
          for service in car-service gateway payment-service rental-service; do
             sed -i "s|tag: latest|tag: ${{ github.sha }}|g" "./charts/apps/$service/values.yaml"
          done

      - name: Deploy Microservices via Helm to Cluster
        run: |
          for service in car-service gateway payment-service rental-service; do
            sed -i "s|KEYCLOAK_ISSUER.*|KEYCLOAK_ISSUER: \"http://keycloak.rsoi-lab5.svc.cluster.local:8080/realms/rsoi-realm\"|" "./charts/apps/$service/values.yaml"
            sed -i "s|KEYCLOAK_JWKS_URI.*|KEYCLOAK_JWKS_URI: \"http://keycloak.rsoi-lab5.svc.cluster.local:8080/realms/rsoi-realm/protocol/openid-connect/certs\"|" "./charts/apps/$service/values.yaml"
            sed -i "s|KEYCLOAK_CLIENT_ID.*|KEYCLOAK_CLIENT_ID: \"lab5-client\"|" "./charts/apps/$service/values.yaml"
          done

          helm upgrade --install car-service ./charts/common -f ./charts/apps/car-service/values.yaml -n rsoi-lab5 --create-namespace
          helm upgrade --install gateway ./charts/common -f ./charts/apps/gateway/values.yaml -n rsoi-lab5 --create-namespace
          helm upgrade --install payment-service ./charts/common -f ./charts/apps/payment-service/values.yaml -n rsoi-lab5 --create-namespace
          helm upgrade --install rental-service ./charts/common -f ./charts/apps/rental-service/values.yaml -n rsoi-lab5 --create-namespace

      - name: Wait for Microservices in Cluster to be Ready
        run: |
          kubectl wait -n rsoi-lab5 deployment/gateway deployment/car-service deployment/payment-service deployment/rental-service --for=condition=Available --timeout=5m

      - name: Make test script executable
        run: chmod +x ./scripts/test-script.sh

      - name: Autograding
        uses: education/autograding@v1
        continue-on-error: true
